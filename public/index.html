Scan Student ID and Medication
<label>Nurse Name: <input type="text" id="nurseName" required></label><br><br>
Shift ID: <input type="text" id="shiftId" required><br><br>
Student ID:
Medication Barcode:
Log Administration
<h2>Live Medication Log</h2>
<div id="live-log">Loading logs...</div>
<button id="complete-btn">✅ Complete Med Pass & Download CSV</button>

<script>
  // Persist nurse name in localStorage
  const nurseInput = document.getElementById("nurseName");
  nurseInput.value = localStorage.getItem("nurseName") || "";
  nurseInput.addEventListener("input", () => {
    localStorage.setItem("nurseName", nurseInput.value);
  });
</script>
<script>
  function loadLiveLog() {
    fetch("/logs")
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("live-log");
        container.innerHTML = "";

        if (!data.length) {
          container.textContent = "No logs yet.";
          return;
        }

        data.slice(0, 10).forEach(entry => {
          const div = document.createElement("div");
          const time = new Date(entry.timestamp).toLocaleString();
          div.innerHTML = `<strong>${entry.student_id}</strong> – ${entry.med_code} <span style="color:gray;">@ ${time}</span>`;
          container.appendChild(div);
        });
      })
      .catch(err => {
        document.getElementById("live-log").textContent = "Error loading logs.";
      });
  }

  loadLiveLog();
  setInterval(loadLiveLog, 10000);

  document.getElementById("complete-btn").addEventListener("click", function () {
    if (!confirm("Are you sure you want to complete the med pass and download the log?")) return;

    fetch("/complete-pass")
      .then(res => res.json())
      .then(data => {
        if (!data.length) {
          alert("No data to export.");
          return;
        }

        const nurseName = document.getElementById("nurseName").value || "Unknown Nurse";
        const shiftId = document.getElementById("shiftId").value || "No Shift ID";
        const today = new Date().toISOString().slice(0, 10);
        const csvHeader = `Nurse Name: ${nurseName}\nShift ID: ${shiftId}\nExport Date: ${today}\n\nStudent ID,Medication Code,Timestamp\n`;
        const csvRows = data.map(row =>
          `"${row.student_id}","${row.med_code}","${new Date(row.timestamp).toLocaleString()}"`
        );
        const csvContent = csvHeader + csvRows.join("\n");

        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `med-pass-${today}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(() => {
          window.location.href = "/";
        }, 1000);
      })
      .catch(err => {
        alert("Failed to complete med pass: " + err.message);
      });
  });
</script>
